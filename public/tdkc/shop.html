<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TentDrop Shop</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://www.paypal.com/sdk/js?client-id=Adyi6FYnGh5pq8w9jdA3NxS_m-2U5wgrCdviCCfsDEDmo8plIpB94kLAiP8jnroCL-cJdt96Y3QkFERA&currency=USD"></script>
    <style>
        body { padding: 20px; }
        .product-card { transition: transform 0.2s; }
        .product-card:hover { transform: translateY(-5px); }
        .cart-overlay {
            position: fixed; top: 0; right: 0; width: 350px; height: 100%;
            background: white; box-shadow: -2px 0 5px rgba(0,0,0,0.1);
            padding: 20px; display: none; z-index: 1000; overflow-y: auto;
        }
        .cart-open { display: block; }
    </style>
</head>
<body>
    <nav class="navbar navbar-light bg-light mb-4">
        <div class="container">
            <a class="navbar-brand" href="#">TentDrop Shop</a>
            <button class="btn btn-outline-primary" onclick="toggleCart()">Cart (<span id="cart-count">0</span>)</button>
        </div>
    </nav>

    <div class="container">
        <div id="products-grid" class="row">
            <!-- Products loaded here -->
        </div>
    </div>

    <!-- Cart Sidebar -->
    <div id="cart-sidebar" class="cart-overlay">
        <div class="d-flex justify-content-between mb-3">
            <h4>Your Cart</h4>
            <button class="btn btn-sm btn-danger" onclick="toggleCart()">X</button>
        </div>
        <div id="cart-items"></div>
        <hr>
        <div class="d-flex justify-content-between">
            <h5>Total:</h5>
            <h5 id="cart-total">$0.00</h5>
        </div>
        <div id="paypal-button-container" class="mt-3"></div>
    </div>

    <script>
        const API_BASE = '/tdkc';
        let cart = { items: [] };

        async function init() {
            await loadProducts();
            await loadCart();
        }

        async function loadProducts() {
            const res = await fetch(`${API_BASE}/products`);
            const products = await res.json();
            const container = document.getElementById('products-grid');
            
            container.innerHTML = products.map(p => `
                <div class="col-md-4 mb-4">
                    <div class="card product-card h-100">
                        ${p.image_key ? `<img src="${API_BASE}/media/${p.image_key}" class="card-img-top" style="height: 200px; object-fit: cover;">` : ''}
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">${p.name}</h5>
                            <p class="card-text text-muted">${p.description}</p>
                            <div class="mt-auto d-flex justify-content-between align-items-center">
                                <span class="h5 mb-0">$${p.price.toFixed(2)}</span>
                                <button class="btn btn-primary" onclick="addToCart('${p.id}')">Add to Cart</button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function loadCart() {
            const res = await fetch(`${API_BASE}/cart`);
            cart = await res.json();
            updateCartUI();
        }

        async function addToCart(productId) {
            const res = await fetch(`${API_BASE}/cart`, {
                method: 'POST',
                body: JSON.stringify({ productId, quantity: 1 })
            });
            cart = await res.json();
            updateCartUI();
            // document.getElementById('cart-sidebar').classList.add('cart-open');
        }

        async function removeFromCart(productId) {
            const res = await fetch(`${API_BASE}/cart/${productId}`, { method: 'DELETE' });
            cart = await res.json();
            updateCartUI();
        }

        function updateCartUI() {
            const count = cart.items.reduce((acc, item) => acc + item.quantity, 0);
            document.getElementById('cart-count').innerText = count;

            const itemsContainer = document.getElementById('cart-items');
            let total = 0;

            itemsContainer.innerHTML = cart.items.map(item => {
                total += item.price * item.quantity;
                return `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <div>${item.name}</div>
                            <small class="text-muted">${item.quantity} x $${item.price}</small>
                        </div>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeFromCart('${item.productId}')">&times;</button>
                    </div>
                `;
            }).join('');

            document.getElementById('cart-total').innerText = '$' + total.toFixed(2);
            renderPayPalButton(total);
        }

        function toggleCart() {
            document.getElementById('cart-sidebar').classList.toggle('cart-open');
        }

        let paypalButtonRendered = false;
        function renderPayPalButton(total) {
            if (total <= 0) {
                document.getElementById('paypal-button-container').innerHTML = '';
                paypalButtonRendered = false;
                return;
            }
            
            if (paypalButtonRendered) return; // Don't re-render excessively

            document.getElementById('paypal-button-container').innerHTML = '';
            paypal.Buttons({
                createOrder: async (data, actions) => {
                    const res = await fetch(`${API_BASE}/create-order`, {
                        method: 'POST'
                    });
                    const orderData = await res.json();
                    return orderData.id;
                },
                onApprove: async (data, actions) => {
                    const res = await fetch(`${API_BASE}/capture-order`, {
                        method: 'POST',
                        body: JSON.stringify({ orderID: data.orderID })
                    });
                    const orderData = await res.json();
                    if (orderData.success) {
                        alert('Transaction completed by ' + orderData.orderID);
                        loadCart();
                        toggleCart();
                    } else {
                        alert('Transaction failed');
                    }
                }
            }).render('#paypal-button-container');
            paypalButtonRendered = true;
        }

        init();
    </script>
</body>
</html>
